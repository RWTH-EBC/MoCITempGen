# Variables
# ci_stage_prepare_page : ${ci_stage_prepare_page}
# result_dir : ${result_dir}
# expire_in_time : ${expire_in_time}
# modelicapyci_api_github_module: ${modelicapyci_api_github_module}
# arg: ${arg}

stages:
    - ${ci_stage_prepare_page}
prepare_pages:
    stage: ${ci_stage_prepare_page}
    before_script:
     - !reference [.github_ssh_auth, script]
     - !reference [.activate_python_and_install_requirements, script]
    script:
        - mkdir -p $CI_COMMIT_REF_NAME
        - python -m ${modelicapyci_api_github_module} ${arg}
        - if [ ! -d "${result_dir}" ]; then echo "No results in this pipeline, no pages to publish" && exit 0; fi
        - python -m ModelicaPyCI.deploy.create_central_index_html
        - cp -r ${result_dir}/* $CI_COMMIT_REF_NAME
    artifacts:
        paths:
         - $CI_COMMIT_REF_NAME
        expire_in: ${expire_in_time}
    when: always
    allow_failure: true
    rules:
        - !reference [.rules:PR , rules]
